pipeline {
    agent { label 'win' }

    tools { maven 'M3.9' }

    stages {
        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Build with Maven') {
            steps { bat 'mvn -B -DskipTests clean package' }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    bat 'docker build -t vishnupriyaerakasani/demo:latest .'
                    bat 'docker run -d --rm --name demo_demo -p 8080:8080 vishnupriyaerakasani/demo:latest'
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                script {
                    withCredentials([string(credentialsId: 'dockerhub_token', variable: 'DOCKER_TOKEN')]) {
                        bat 'echo %DOCKER_TOKEN% | docker login --username vishnupriyaerakasani --password-stdin'
                        bat 'docker push vishnupriyaerakasani/demo:latest'
                        bat 'docker logout'
                    }
                }
            }
        }
    }
}
